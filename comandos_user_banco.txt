CREATE USER ramais_user WITH PASSWORD 'UserPadrao2026';
GRANT ALL PRIVILEGES ON DATABASE ramais_db TO ramais_user;

-- garantir acesso ao banco
GRANT ALL PRIVILEGES ON DATABASE ramais_db TO ramais_user;

-- permitir uso do schema public
GRANT USAGE ON SCHEMA public TO ramais_user;

-- permitir criar tabelas
GRANT CREATE ON SCHEMA public TO ramais_user;

-- garantir privilégios em tabelas futuras
ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT ALL ON TABLES TO ramais_user;

ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT ALL ON SEQUENCES TO ramais_user;

/////////////////////////////////////////////////////////////////////////

COMO CONFIGURAR SERVIDOR:

No servidor, o fluxo fica assim:

Clonar o projeto e instalar deps

bash
    git clone ...
    cd ajuda-nova
    npm install

Alterar o ip para o arquivo:

  src/lib/auth-client

Gerar o Prisma Client (mesmo com output em src/generated/prisma)
Sim, ainda precisa rodar:

bash
    npx prisma generate

O client é gerado para o SO do servidor; não é garantido que o client gerado no seu PC funcione lá.
​

Criar as tabelas no banco

Em produção, em vez de migrate dev, use:

bash
    npx prisma migrate deploy

Isso aplica todas as migrations que já estão na pasta prisma/migrations.
​

Rodar o script do OWNER (uma vez)

Se estiver usando o fluxo compilado:

bash
    node dist-scripts/scripts/create-initial-owner.js

(se ainda não tiver a pasta dist-scripts no servidor, suba ela no git ou repita o passo de tsc -p tsconfig.scripts.json lá e depois rode o node igual fez no seu PC).

Exemplo:
    PS C:\Users\kaue.santos\Desktop\ajuda-nova> npx tsc -p tsconfig.scripts.json
    >> 

    ***** ARRUME NO ARQUIVO dist-scripts/src/lib/prisma.js o caminho ../generated/prisma/client para ../../../src/generated/prisma/client *****

    PS C:\Users\kaue.santos\Desktop\ajuda-nova> node dist-scripts/scripts/create-initial-owner.js
    Criando/atualizando usuário owner inicial...
    Usuário owner pronto: admin.teste@naturafrig.com.br

Resumindo: no servidor você sempre precisa ao menos npm install, npx prisma generate, npx prisma migrate deploy e depois o script que cria o primeiro OWNER.

/----------------------------------------------------------------------------------------------------------------------

Para criar user inicial (na raiz do projeto):

    npx tsc -p tsconfig.scripts.json

    node dist-scripts/scripts/create-initial-owner.js
        ou
    npm run create:owner

/----------------------------------------------------------------------------------------------------------------------

# 1) Build de produção
npm run build

# 2) Subir com PM2 usando o script "start"
pm2 start npm --name "ajuda-nova" -- run start


kaue_santos@SrvLab01:~$ sudo -i -u postgres
postgres@SrvLab01:~$ psql
psql (17.6 (Debian 17.6-0+deb13u1))
Digite "help" para obter ajuda.

postgres=# CREATE USER ramais_user WITH PASSWORD 'UserPadrao2026';
CREATE ROLE
postgres=# CREATE DATABASE ramais_db OWNER ramais_user;
CREATE DATABASE
postgres=#


sudo ufw status
sudo ufw allow 5050/tcp
sudo ufw disallow 5000/tcp
sudo ufw delete allow 5000/tcp



///////////////////////////////////////////////////////////////////////////////



COMO ALTERAR BANCO DE DADOS (ADICIONAR/ALTERAR ALGO NAS TABELAS)

1. Passo 1 – Alterar o schema
No seu prisma/schema.prisma, atualize o modelo Ramal:

EXEMPLO:
model Ramal {
  id        Int      @id @default(autoincrement())
  numero    String
  nome      String?
  setor     String
  unidadeId Int
  unidade   Unidade  @relation(fields: [unidadeId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ramais")
  @@unique([unidadeId, numero]) // adiciona chave única
}
Isso só muda o schema lógico do Prisma; ainda não alterou o banco.
​

2. Passo 2 – Gerar a migração
Na raiz do projeto, rode:

bash
    npx prisma migrate dev --name add_unique_ramal_unidade_numero

O Prisma vai:

Comparar o schema atual com o banco.
Gerar um arquivo .sql em prisma/migrations/... que adiciona a constraint UNIQUE (unidadeId, numero) na tabela ramais.
​Se ele tentar dropar a tabela, é porque você está em ambiente de desenvolvimento com --create-only ou porque o Prisma não consegue inferir a alteração sem recriar; nesse caso, você pode:
Deixar ele gerar a migração e depois ajustar o SQL à mão, trocando DROP TABLE por ALTER TABLE ... ADD CONSTRAINT ..., ou
Em desenvolvimento, aceitar o reset (se os dados não forem críticos) e depois recriar os registros.

3. Passo 3 – Aplicar a migração no banco
Depois de gerar a migração, o comando acima já aplica no banco se você estiver em dev.
Em produção, você normalmente faz:

bash
    npx prisma migrate deploy

Esse comando aplica todas as migrações pendentes no banco PostgreSQL configurado em DATABASE_URL.
​

4. Passo 4 – Regenerar o Prisma Client
Sempre que alterar o schema:

bash
    npx prisma generate

Isso atualiza o client em src/generated/prisma para refletir o novo schema.
​

5. Se quiser ver o SQL antes de aplicar
Você pode gerar a migração sem aplicar:

bash
    npx prisma migrate dev --name add_unique_ramal_unidade_numero --create-only
Depois abre o arquivo .sql em prisma/migrations/... e verifica se está fazendo algo seguro (ex.: ALTER TABLE ramais ADD CONSTRAINT ...).
​





/////////////////////////////////////////////////////////////////////

COMO ATUALIZAR O SERVER:

  pm2 delete ajuda-nova
  git pull origin main
  npm run build
  pm2 start npm --name "ajuda-nova" -- run start